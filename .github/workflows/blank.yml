name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  # push:
  #   branches: [ "main" ]
  # pull_request:
  #   branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      job_type:
        description: "Select the type of job"
        required: true
        default: "build-all"
        type: choice
        options:
          - build-dev-apk
          - build-test-apk
          - build-server
          - build-test
          - build-all
      branch:
        description: "Select branch to build"
        required: true
        default: "master"
        type: choice
        options:
          - master
          - manual-package
  schedule:
    # æ¯å¤© UTC 15:30 è§¦å‘å®Œæ•´æ„å»º (å¼€å‘APK + æµ‹è¯•APK + æœåŠ¡å™¨)
    - cron: '30 15 * * *'

jobs:
  prepare:
    runs-on: build-runner
    outputs:
      ref_name: ${{ steps.set-ref.outputs.ref_name }}
      sha: ${{ steps.set-ref.outputs.sha }}
    steps:
      - name: Fetch & Copy
        run: |
          sh ./prepare-job.sh \
            "${{ github.event_name }}" \
            "${{ github.event.inputs.job_type }}" \
            "${{ github.event.inputs.branch }}"

      - name: Set ref and sha from local
        id: set-ref
        run: |
          sh ./get-git-info.sh \
            "${{ github.event_name }}" \
            "${{ github.event.inputs.job_type }}" \
            "${{ github.event.inputs.branch }}"


  # å•ç‹¬æ„å»ºï¼šå¼€å‘ç‰ˆAPK
  build-dev-apk-only:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-dev-apk' }}
    needs: prepare
    runs-on: build-runner
    steps:
      - name: Build Development APK Only
        run: |
          echo "ğŸš€ Building Development APK Only..."
          source ~/.zshrc
          source ./env-prepare.sh
          sh ./client/build-dev.sh

  # å•ç‹¬æ„å»ºï¼šæµ‹è¯•ç‰ˆAPK
  build-test-apk-only:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-test-apk' }}
    needs: prepare
    runs-on: build-runner
    steps:
      - name: Build Test APK Only
        run: |
          echo "ğŸš€ Building Test APK Only..."
          source ~/.zshrc
          source ./env-prepare.sh
          sh ./client/build.sh

  # å•ç‹¬æ„å»ºï¼šæœåŠ¡å™¨
  build-server-only:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-server' }}
    needs: prepare
    runs-on: build-runner
    steps:
      - name: Build Server Only
        run: |
          echo "ğŸš€ Building Server Only..."
          source ./env-prepare.sh
          sh ./server/build.sh
          sh ./server/container.sh

  # é˜¶æ®µ1ï¼šæœåŠ¡å™¨æ„å»º (ç”¨äºtestå’Œallåœºæ™¯)
  build-server-stage:
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.job_type == 'build-test' || github.event.inputs.job_type == 'build-all') || github.event_name == 'schedule' }}
    needs: prepare
    runs-on: build-runner
    outputs:
      server_status: ${{ steps.server-build.outcome }}
    steps:
      - name: Build Server Stage
        id: server-build
        run: |
          echo "ğŸ–¥ï¸ Stage 1: Building Server..."
          source ./env-prepare.sh
          sh ./server/build.sh
          sh ./server/container.sh
          echo "âœ… Server build completed!"

  # é˜¶æ®µ2Aï¼šæµ‹è¯•APKæ„å»º (ç”¨äºtestå’Œallåœºæ™¯)
  build-test-apk-stage:
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.job_type == 'build-test' || github.event.inputs.job_type == 'build-all') || github.event_name == 'schedule' }}
    needs: prepare
    runs-on: build-runner
    outputs:
      test_apk_status: ${{ steps.test-apk-build.outcome }}
    steps:
      - name: Build Test APK Stage
        id: test-apk-build
        run: |
          echo "ğŸ“± Stage 2A: Building Test APK..."
          source ~/.zshrc
          source ./env-prepare.sh
          sh ./client/build.sh
          echo "âœ… Test APK build completed!"

  # é˜¶æ®µ2Bï¼šå¼€å‘APKæ„å»º (ä»…ç”¨äºallåœºæ™¯ï¼Œä¾èµ–æµ‹è¯•APKå®Œæˆ)
  build-dev-apk-stage:
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-all') || github.event_name == 'schedule' }}
    needs: [prepare, build-test-apk-stage]
    runs-on: build-runner
    outputs:
      dev_apk_status: ${{ steps.dev-apk-build.outcome }}
    steps:
      - name: Build Dev APK Stage
        id: dev-apk-build
        run: |
          echo "ğŸ“± Stage 2B: Building Development APK (after Test APK)..."
          source ~/.zshrc
          source ./env-prepare.sh
          sh ./client/build-dev.sh
          echo "âœ… Development APK build completed!"

  # æµ‹è¯•æ„å»ºå®Œæˆé€šçŸ¥ (Server + Test APK)
  build-test-complete:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-test' }}
    needs: [build-server-stage, build-test-apk-stage]
    runs-on: build-runner
    steps:
      - name: Test Build Summary
        run: |
          echo "ğŸ§ª Test Build Summary"
          echo "Server Status: ${{ needs.build-server-stage.outputs.server_status }}"
          echo "Test APK Status: ${{ needs.build-test-apk-stage.outputs.test_apk_status }}"
          
          if [[ "${{ needs.build-server-stage.outputs.server_status }}" == "success" && "${{ needs.build-test-apk-stage.outputs.test_apk_status }}" == "success" ]]; then
            echo "ğŸ‰ Test build completed successfully!"
          else
            echo "âŒ Test build had failures"
            exit 1
          fi

  # å®Œæ•´æ„å»ºå®Œæˆé€šçŸ¥ (Server + Test APK + Dev APK)
  build-all-complete:
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-all') || github.event_name == 'schedule' }}
    needs: [build-server-stage, build-test-apk-stage, build-dev-apk-stage]
    runs-on: build-runner
    steps:
      - name: All Build Summary
        run: |
          echo "ğŸš€ All Build Summary"
          echo "Server Status: ${{ needs.build-server-stage.outputs.server_status }}"
          echo "Test APK Status: ${{ needs.build-test-apk-stage.outputs.test_apk_status }}"
          echo "Dev APK Status: ${{ needs.build-dev-apk-stage.outputs.dev_apk_status }}"
          
          if [[ "${{ needs.build-server-stage.outputs.server_status }}" == "success" && "${{ needs.build-test-apk-stage.outputs.test_apk_status }}" == "success" && "${{ needs.build-dev-apk-stage.outputs.dev_apk_status }}" == "success" ]]; then
            echo "ğŸ‰ All builds completed successfully!"
          else
            echo "âŒ Some builds had failures"
            exit 1
          fi

  # ç»Ÿä¸€é€šçŸ¥ä»»åŠ¡
  notify:
    if: ${{ always() }}
    needs: [prepare, build-dev-apk-only, build-test-apk-only, build-server-only, build-test-complete, build-all-complete]
    runs-on: build-runner
    steps:
      - name: Send Build Notification
        run: |
          # ç¡®å®šå®é™…æ‰§è¡Œçš„æ„å»ºç±»å‹
          JOB_TYPE="${{ github.event.inputs.job_type || 'build-all' }}"
          
          # æ ¹æ®ä¸åŒçš„æ„å»ºç±»å‹è®¾ç½®ä¸åŒçš„çŠ¶æ€
          case "$JOB_TYPE" in
            "build-dev-apk")
              BUILD_STATUS="${{ needs.build-dev-apk-only.result }}"
              ;;
            "build-test-apk")
              BUILD_STATUS="${{ needs.build-test-apk-only.result }}"
              ;;
            "build-server")
              BUILD_STATUS="${{ needs.build-server-only.result }}"
              ;;
            "build-test")
              BUILD_STATUS="${{ needs.build-test-complete.result }}"
              ;;
            "build-all")
              BUILD_STATUS="${{ needs.build-all-complete.result }}"
              ;;
            *)
              BUILD_STATUS="unknown"
              ;;
          esac
          
          sh ./send-notifications.sh \
            "${{ github.event_name }}" \
            "$JOB_TYPE" \
            "${{ github.workflow }}" \
            "${{ github.repository }}" \
            "${{ needs.prepare.outputs.ref_name }}" \
            "${{ needs.prepare.outputs.sha }}" \
            "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            "$BUILD_STATUS"

